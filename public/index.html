<!doctype html>
<html lang="hi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Employee Check-in / Check-out</title>
  <style>
    body { font-family: Arial, sans-serif; max-width: 720px; margin: 2rem auto; padding: 1rem; }
    video, canvas { width: 100%; max-width: 480px; border: 1px solid #ddd; border-radius: 8px; }
    .controls { margin-top: 0.5rem; display:flex; gap:0.5rem; }
    input, button { padding:0.5rem; font-size:1rem; }
  </style>
</head>
<body>
  <h2>Employee Check-in / Check-out</h2>

  <label>Employee ID: <input id="empId" placeholder="e.g. E123" /></label>
  <div style="margin-top:1rem">
    <video id="video" autoplay playsinline></video>
    <canvas id="canvas" style="display:none;"></canvas>
  </div>

  <div class="controls">
    <button id="startCamera">Start Camera</button>
    <button id="checkIn">Check In (Photo)</button>
    <button id="checkOut">Check Out (Photo)</button>
  </div>

  <div id="status" style="margin-top:1rem;color:green"></div>

<script>
const API_BASE = "/api"; // Change to full URL if backend hosted elsewhere, e.g. "https://yourdomain.com/api"
const video = document.getElementById('video');
const canvas = document.getElementById('canvas');
const startBtn = document.getElementById('startCamera');
const checkInBtn = document.getElementById('checkIn');
const checkOutBtn = document.getElementById('checkOut');
const status = document.getElementById('status');

let stream = null;

async function startCamera(){
  try{
    stream = await navigator.mediaDevices.getUserMedia({video:{facingMode: "user"}, audio:false});
    video.srcObject = stream;
    status.textContent = "Camera active. Ready to capture.";
  } catch(e){
    status.style.color = "red";
    status.textContent = "Camera access failed: " + e.message;
  }
}

function captureBlob(){
  const w = video.videoWidth;
  const h = video.videoHeight;
  canvas.width = w; canvas.height = h;
  const ctx = canvas.getContext('2d');
  ctx.drawImage(video, 0, 0, w, h);
  return new Promise(resolve => {
    canvas.toBlob(blob => resolve(blob), 'image/jpeg', 0.85);
  });
}

async function sendCapture(type){
  const empId = document.getElementById('empId').value.trim();
  if(!empId){ status.style.color='red'; status.textContent='Employee ID dalen.'; return; }
  if(!stream){ status.style.color='red'; status.textContent='Camera start karein pehle.'; return; }
  status.style.color='black'; status.textContent = "Photo le rahe hain...";
  const blob = await captureBlob();
  const form = new FormData();
  form.append('employeeId', empId);
  form.append('type', type); // "checkin" or "checkout"
  form.append('photo', blob, `${empId}_${type}_${Date.now()}.jpg`);
  // optionally add geolocation
  if(navigator.geolocation){
    try{
      const pos = await new Promise((res,rej)=> navigator.geolocation.getCurrentPosition(res, rej, {timeout:5000}));
      form.append('latitude', pos.coords.latitude);
      form.append('longitude', pos.coords.longitude);
    } catch(e) {
      // ignore if user denies
    }
  }

  try{
    const resp = await fetch(`${API_BASE}/capture`, { method: 'POST', body: form });
    const data = await resp.json();
    if(resp.ok){
      status.style.color='green';
      status.textContent = `${type} saved at ${data.timestamp}`;
    } else {
      status.style.color='red';
      status.textContent = `Server error: ${data.error || resp.statusText}`;
    }
  } catch(err){
    status.style.color='red';
    status.textContent = 'Network error: ' + err.message;
  }
}

startBtn.addEventListener('click', startCamera);
checkInBtn.addEventListener('click', ()=> sendCapture('checkin'));
checkOutBtn.addEventListener('click', ()=> sendCapture('checkout'));
</script>
</body>
</html>
